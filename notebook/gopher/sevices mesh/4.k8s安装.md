# k8s 安装

## 安装步骤

- 1、安装虚拟机（centos7）
- 2、修改hostname（hostnamectl set-hostname kubersystem）
- 3、更新centos的[内核版本](https://jingyan.baidu.com/article/6b182309fab06eba58e15995.html)
- 4、更新系统（yum -y update）
- 5、安装[最新版docker](https://docs.docker.com/engine/install/centos/)
- 6、sealos安装k8s
  
  - 下载并安装sealos, sealos是个golang的二进制工具，直接下载拷贝到bin目录即可, release页面也可下载

  ```wget sealos
  wget -c https://sealyun.oss-cn-beijing.aliyuncs.com/latest/sealos && chmod +x sealos && mv sealos /usr/bin
  ```

  - 下载离线资源包

  ```download
  wget -c https://sealyun.oss-cn-beijing.aliyuncs.com/d551b0b9e67e0416d0f9dce870a16665-1.18.0/kube1.18.0.tar.gz
  ```

  - 安装一个单节点的kubernetes

  ```setup
  sealos init --passwd 123456 --master 192.168.2.89 --pkg-url /home/kube1.18.0.tar.gz --version v1.18.0
  ```

## master 初始化

```初始化
- kubeadm init --apiserver-advertise-address=192.168.2.188 --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.17.0 --service-cidr=10.1.0.0/16 --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=Swap
```

- kubectl taint nodes --all node-role.kubernetes.io/master-
  - 允许 master 部署 pod
- kubectl taint nodes centos-master-1 node-role.kubernetes.io/master=true:NoSchedule
  - 禁止 master 部署 pod

## 配置 kubectl

```配置kubectl
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

- 如果是 root 用户，则可以运行:

```root
export KUBECONFIG=/etc/kubernetes/admin.conf
```

## 加入 k8s 集群

- kubeadm join 192.168.2.188:6443 --token p51zg5.anzyjjx2rchu9o00 --discovery-token-ca-cert-hash sha256:e96f702537c41c85cc9a478b7c035a79df4354fbdf771e3e3c25c60fbcde5431

## 开启代理

- 文章：https://www.jianshu.com/p/824912d9afda
- systemctl start shadowsocks
- systemctl stop shadowsocks
- systemctl start privoxy
- systemctl stop privoxy
- vi /etc/profile
- source /etc/profile

## 安装 flannel 时的问题

- 安装：kubectl apply -f kube-flannel.yml
- 错误：pod cidr not assigned
- 解决方案：
  - 1、kubeadm reset
  - 2、然后重装 flannel
  - 3、network 要与--pod-network-cidr 保持一致

## 主节点加入 node 集群

- 1、kubectl describe node node1 | grep Taint
- 2、kubectl taint nodes node1 node-role.kubernetes.io/master-

## 访问 dashboard

- 开始代理：kubectl proxy --address=192.168.0.188 --disable-filter=true
- 访问地址：http://192.168.0.188:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/#!/login

## k8s 常用命令

- kubectl get pod,svc -o wide -n kube-system

## Rancher 管理 k8s

- admin wenbin83528

## 参考资料

- [kubeadm 部署 K8S 集群](https://www.cnblogs.com/ElegantSmile/p/12088520.html)
- [kubeadm 快速部署 Kubernetes 单节点](https://www.cnblogs.com/Tempted/p/10671292.html)
- [centos7 怎么升级内核版本](https://jingyan.baidu.com/article/6b182309fab06eba58e15995.html)
